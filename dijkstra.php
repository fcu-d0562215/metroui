<?php
$graph_array = [1=>["name"=>"丘逢甲紀念館側一","lat"=>24.178305,"long"=>120.647944,"next"=>[104]],["name"=>"丘逢甲紀念館側二","lat"=>24.178315,"long"=>120.648576,"next"=>[80,85]],["name"=>"丘逢甲紀念館大門","lat"=>24.178444,"long"=>120.648249,"next"=>[97,75]],["name"=>"人言大樓側一","lat"=>24.179636,"long"=>120.648502,"next"=>[107,64,63]],["name"=>"人言大樓側二","lat"=>24.179631,"long"=>120.648740,"next"=>[62,65,63]],["name"=>"人言大樓啟堰廳","lat"=>24.179267,"long"=>120.648419,"next"=>[64,69,23]],["name"=>"人言大樓大門","lat"=>24.179619,"long"=>120.648607,"next"=>[63]],["name"=>"体育馆主要路口","lat"=>24.181498,"long"=>120.649048,"next"=>[105,108,51]],["name"=>"创客中心","lat"=>24.179714,"long"=>120.649153,"next"=>[59,62]],["name"=>"商學大樓側一","lat"=>24.178423,"long"=>120.650045,"next"=>[19,77]],["name"=>"商學大樓側二","lat"=>24.178421,"long"=>120.649491,"next"=>[19,77,84,32]],["name"=>"圖書館大門","lat"=>24.178707,"long"=>120.648595,"next"=>[103]],["name"=>"土木水利館大門","lat"=>24.181233,"long"=>120.647038,"next"=>[95,50]],["name"=>"学思楼側一","lat"=>24.181622,"long"=>120.646785,"next"=>[18,15,50]],["name"=>"学思楼側二","lat"=>24.181368,"long"=>120.646603,"next"=>[95,14,16]],["name"=>"学思楼大门","lat"=>24.181501,"long"=>120.646807,"next"=>[18,15,50]],["name"=>"學園出口（北門）","lat"=>24.181906,"long"=>120.648203,"next"=>[51,48]],["name"=>"学思楼側三","lat"=>24.181774,"long"=>120.646641,"next"=>[14,16,48,91]],["name"=>"學園出口（東門）","lat"=>24.178520,"long"=>120.650268,"next"=>[66,77,11,10]],["name"=>"路口","lat"=>24.179361,"long"=>120.648620,"next"=>[63,65,67,64]],["name"=>"學園出口（郵局）","lat"=>24.178115,"long"=>120.646629,"next"=>[81]],["name"=>"工學院側一","lat"=>24.179188,"long"=>120.647448,"next"=>[61,72]],["name"=>"工學院側二","lat"=>24.179205,"long"=>120.648185,"next"=>[64,69,6]],["name"=>"工學院大門","lat"=>24.179106,"long"=>120.647908,"next"=>[71]],["name"=>"建築館正門","lat"=>24.179566,"long"=>120.646644,"next"=>[94,43,109]],["name"=>"忠勤樓側一","lat"=>24.179217,"long"=>120.646626,"next"=>[94]],["name"=>"忠勤樓側二","lat"=>24.179222,"long"=>120.647263,"next"=>[72,61]],["name"=>"忠勤樓大門","lat"=>24.179060,"long"=>120.646931,"next"=>[30,72,89,92]],["name"=>"忠勤樓底樓（和語文同方向及面向工學院）","lat"=>24.179423,"long"=>120.647255,"next"=>[61,72]],["name"=>"忠勤樓後一（面對語文）","lat"=>24.179430,"long"=>120.646945,"next"=>[109,44,110,61,28]],["name"=>"理學大樓大门","lat"=>24.181180,"long"=>120.647412,"next"=>[50]],["name"=>"科行館側一","lat"=>24.178337,"long"=>120.649343,"next"=>[96,11,84]],["name"=>"科行館側二","lat"=>24.178315,"long"=>120.648748,"next"=>[80,85]],["name"=>"育樂館側(右)","lat"=>24.180401,"long"=>120.647148,"next"=>[52,57]],["name"=>"育樂館側(左)","lat"=>24.180394,"long"=>120.646610,"next"=>[53,58]],["name"=>"育樂館大門","lat"=>24.180011,"long"=>120.646897,"next"=>[58,57]],["name"=>"行政一館側門","lat"=>24.178593,"long"=>120.647299,"next"=>[74,79]],["name"=>"行政一館大門","lat"=>24.178679,"long"=>120.646988,"next"=>[74,93]],["name"=>"行政一館後門","lat"=>24.178477,"long"=>120.647018,"next"=>[78,79]],["name"=>"行政二館側一","lat"=>24.178590,"long"=>120.647439,"next"=>[74,79]],["name"=>"行政二館側二","lat"=>24.178570,"long"=>120.647873,"next"=>[75,73]],["name"=>"行政二館大門","lat"=>24.178692,"long"=>120.647628,"next"=>[74,73]],["name"=>"語文一","lat"=>24.179623,"long"=>120.646797,"next"=>[111,109,25]],["name"=>"語文二","lat"=>24.179625,"long"=>120.646956,"next"=>[112,61,30,109]],["name"=>"資訊電機館側門","lat"=>24.179368,"long"=>120.649039,"next"=>[65,62,68]],["name"=>"資訊電機館大門","lat"=>24.179147,"long"=>120.649544,"next"=>[66,70]],["name"=>"資訊電機館後門","lat"=>24.179353,"long"=>120.649544,"next"=>[59,62,87]],["name"=>"路口","lat"=>24.181830,"long"=>120.647252,"next"=>[91,18,50,17]],["name"=>"學思園","lat"=>24.181559,"long"=>120.647583,"next"=>[50,51]],["name"=>"路口","lat"=>24.181310,"long"=>120.647251,"next"=>[48,49,51,31,52,13,95,16,14]],["name"=>"路口","lat"=>24.181374,"long"=>120.648171,"next"=>[17,8,108,49,50]],["name"=>"路口","lat"=>24.180743,"long"=>120.647279,"next"=>[57,34,53,108,50]],["name"=>"路口","lat"=>24.180711,"long"=>120.646593,"next"=>[52,35,58,95]],["name"=>"路口","lat"=>24.179970,"long"=>120.650103,"next"=>[59,88,106]],["name"=>"路口","lat"=>24.179950,"long"=>120.648996,"next"=>[105,106,62,56]],["name"=>"路口","lat"=>24.179954,"long"=>120.648267,"next"=>[60,57,108,55]],["name"=>"路口","lat"=>24.179924,"long"=>120.647327,"next"=>[56,61,112,113,58,34,52,36]],["name"=>"路口","lat"=>24.179912,"long"=>120.646571,"next"=>[53,35,36,57,111,112,94]],["name"=>"路口","lat"=>24.179735,"long"=>120.650115,"next"=>[54,66,47,87,9,62]],["name"=>"路口","lat"=>24.179630,"long"=>120.648279,"next"=>[107,56,61]],["name"=>"路口","lat"=>24.179598,"long"=>120.647341,"next"=>[60,22,72,27,29,30,109,44,110,57]],["name"=>"路口","lat"=>24.179584,"long"=>120.648975,"next"=>[55,9,87,59,47,45,65,63,5,68]],["name"=>"路口","lat"=>24.179542,"long"=>120.648619,"next"=>[7,5,62,65,20,64,107,4]],["name"=>"路口","lat"=>24.179352,"long"=>120.648316,"next"=>[107,4,63,20,6,69,23]],["name"=>"路口","lat"=>24.179370,"long"=>120.648925,"next"=>[62,45,68,20,63,5]],["name"=>"路口","lat"=>24.179037,"long"=>120.650137,"next"=>[19,46,70,59]],["name"=>"路口","lat"=>24.179012,"long"=>120.648640,"next"=>[20,68,103,69]],["name"=>"路口","lat"=>24.179017,"long"=>120.649024,"next"=>[65,62,45,70,67]],["name"=>"路口","lat"=>24.179008,"long"=>120.648310,"next"=>[67,103,101,23,64,6]],["name"=>"路口","lat"=>24.179010,"long"=>120.649311,"next"=>[46,96,66,68]],["name"=>"路口","lat"=>24.179000,"long"=>120.647936,"next"=>[24,101,100,73,72]],["name"=>"路口","lat"=>24.178975,"long"=>120.647354,"next"=>[71,74,89,28,27,29,61,22]],["name"=>"路口","lat"=>24.178738,"long"=>120.647941,"next"=>[71,101,100,75,41,42,74]],["name"=>"路口","lat"=>24.178740,"long"=>120.647370,"next"=>[72,73,42,40,79,37,38,93]],["name"=>"路口","lat"=>24.178544,"long"=>120.647928,"next"=>[73,3,104,41]],["name"=>"路口","lat"=>24.178469,"long"=>120.648546,"next"=>[99,80,97]],["name"=>"路口","lat"=>24.178446,"long"=>120.649409,"next"=>[11,84,96,10,19]],["name"=>"路口","lat"=>24.178423,"long"=>120.646651,"next"=>[93,39,79,81]],["name"=>"路口","lat"=>24.178445,"long"=>120.647355,"next"=>[82,78,39,37,74,40]],["name"=>"路口","lat"=>24.178347,"long"=>120.648650,"next"=>[76,2,85,33,96]],["name"=>"路口","lat"=>24.178215,"long"=>120.646668,"next"=>[78,86,82,21]],["name"=>"路口","lat"=>24.178245,"long"=>120.647362,"next"=>[81,86,79,104]],["name"=>"路口","lat"=>24.178125,"long"=>120.647904,"next"=>[85,104]],["name"=>"路口","lat"=>24.178173,"long"=>120.649425,"next"=>[85,32,77,11]],["name"=>"路口","lat"=>24.178144,"long"=>120.648649,"next"=>[84,83,33,80,2]],["name"=>"郵局","lat"=>24.178150,"long"=>120.646880,"next"=>[81,82]],["name"=>"電子通訊館大門","lat"=>24.179759,"long"=>120.649528,"next"=>[59,62,47]],["name"=>"電子通訊館後門","lat"=>24.179922,"long"=>120.649506,"next"=>[106,54]],["name"=>"路口","lat"=>24.178926,"long"=>120.646643,"next"=>[94,92,28,72,93]],["name"=>"摩斯門正門","lat"=>24.181303,"long"=>120.646474,"next"=>[95]],["name"=>"摩斯門側門","lat"=>24.181806,"long"=>120.646477,"next"=>[18,48]],["name"=>"忠勤樓側三","lat"=>24.179069,"long"=>120.646667,"next"=>[89,28]],["name"=>"路口","lat"=>24.178729,"long"=>120.646647,"next"=>[89,74,38,78]],["name"=>"路口","lat"=>24.179568,"long"=>120.646575,"next"=>[58,25,26,89]],["name"=>"路口","lat"=>24.181304,"long"=>120.646502,"next"=>[50,13,53,15,90]],["name"=>"路口","lat"=>24.178452,"long"=>120.649313,"next"=>[70,77,32,80]],["name"=>"路口","lat"=>24.178519,"long"=>120.648244,"next"=>[102,76,3]],["name"=>"路口","lat"=>24.178605,"long"=>120.648468,"next"=>[99,103]],["name"=>"路口","lat"=>24.178530,"long"=>120.648586,"next"=>[98,76]],["name"=>"路口","lat"=>24.178697,"long"=>120.648065,"next"=>[101,102,73,71]],["name"=>"路口","lat"=>24.179003,"long"=>120.648051,"next"=>[100,73,71,69]],["name"=>"路口","lat"=>24.178643,"long"=>120.648258,"next"=>[100,97,103]],["name"=>"路口","lat"=>24.178699,"long"=>120.648459,"next"=>[69,67,12,98,102]],["name"=>"路口","lat"=>24.178270,"long"=>120.647871,"next"=>[1,83,82,75]],["name"=>"運動場看台","lat"=>24.180387,"long"=>120.649170,"next"=>[108,55,8,106]],["name"=>"路口","lat"=>24.179962,"long"=>120.649249,"next"=>[55,88,54,105]],["name"=>"路口","lat"=>24.179552,"long"=>120.648303,"next"=>[60,4,63,64]],["name"=>"路口","lat"=>24.180770,"long"=>120.648239,"next"=>[51,8,105,56,52]],["name"=>"建築館後門","lat"=>24.179571,"long"=>120.646787,"next"=>[43,44,61,30,25]],["name"=>"語文三","lat"=>24.179642,"long"=>120.647165,"next"=>[113,61,30]],["name"=>"語文四","lat"=>24.179859,"long"=>120.646783,"next"=>[58,43]],["name"=>"語文五","lat"=>24.179869,"long"=>120.646960,"next"=>[58,44,57]],["name"=>"語文六","lat"=>24.179874,"long"=>120.647143,"next"=>[57,110]]];
if ( isset($_GET) && !empty($_GET)){
    function _countRange($lat1,$long1,$lat2,$long2){
        $lat = abs($lat1*1000000-$lat2*1000000);
        $long = abs($long1*1000000-$long2*1000000);
        return intval(round(sqrt( ( ($lat*$lat) + ($long*$long) ) )));
    }
    function _findBiggerIn2DArray($arr){
        $bigger = 0;
        foreach ($arr as $key => $value) {
            if( $value[0] > $arr[$bigger][0] ){
                $bigger = $key;
            }
        }
        return $bigger;
    }
    function _var_dump($var){
        echo "<pre>";
        var_dump($var);
        echo "</pre>";
    }
    function dijkstra($graph_array, $source, $target) {
        $pointList = array();
        $nextPoint = array();
        foreach ($graph_array as $key => $pointValue) {
            $pointInfo = [];
            foreach ($graph_array[$key]["next"] as $value) {
                $currentlat = $pointValue["lat"];
                $currentlong = $pointValue["long"];
                $nextlat = $graph_array[$value]["lat"];
                $nextlong = $graph_array[$value]["long"];
                $pointInfo[$value]=["end"=>$value,"cost"=>_countRange($currentlat,$currentlong,$nextlat,$nextlong)];
            }
            array_push($pointList, $key);
            $dist[$key] = 99999999999999; //to any point is infinity
            $previous[$key] = NULL; //set all point parent to no parrent
            $nextPoint[$key]=$pointInfo;
        }
 
        $dist[$source] = 0;
        //_var_dump($dist);
        while (count($pointList) > 0) {
            $min = 99999999999999;
            foreach ($pointList as $point){
                echo "<div style='width:12.5%;text-align:center;display:inline-block;'>";
                echo $point." ".$dist[$point]."";
                echo "</div>";
                if ($dist[$point] < $min) {
                    $min = $dist[$point];
                    $u = $point;
                }
            }
            $pointList = array_diff($pointList, [$u]); /*remove point $u */
            if ($dist[$u] == 99999999999999 or $u == $target) {
                break;
            }
            if (isset($nextPoint[$u])) {
                foreach ($nextPoint[$u] as $pointInfo) {
                    _var_dump($pointInfo);
                    $alt = $dist[$u] + $pointInfo["cost"];
                    _var_dump($alt);
                    if ($alt < $dist[$pointInfo["end"]]) {
                        $dist[$pointInfo["end"]] = $alt;
                        $previous[$pointInfo["end"]] = $u;
                    }
                }
            }
            // echo "$u nextpoint info <bR>";
            // _var_dump($nextPoint[$u]);
            echo "<HR style='border-color:red;border-width: 10px;'>";
        }
        $path = array();
        $u = $target;
        while (isset($previous[$u])) {
            array_unshift($path, $u);
            $u = $previous[$u];
        }
        array_unshift($path, $u);
        return [$path];
    }
    if( isset($_GET["start"]) ){
        $start = $_GET["start"];
    } elseif ( isset($_GET["lat"]) && isset($_GET["long"]) ) {
        $lat = $_GET["lat"];
        $long = $_GET["long"];
        $realLink = [];
        foreach ($graph_array as $key => $point) {
            $_range = _countRange($lat,$long,$point["lat"],$point["long"]);
            if ( count($realLink)<3 ) {
                array_push($realLink,[$_range,$key]);
            } else {
                $biggerRangeKey = _findBiggerIn2DArray($realLink);
                if ($_range < $realLink[$biggerRangeKey][0]) {
                    $realLink[$biggerRangeKey] = [$_range,$key];
                }
            } 
        }
        $realPointNextLink = [];
        foreach ($realLink as $value) {
            array_push($realPointNextLink, $value[1]);
        }
        array_push($graph_array,["name"=>"目前位置","lat"=>$lat,"long"=>$long,"next"=>$realPointNextLink]);
        $start = count($graph_array);

    }
    $end = $_GET["end"];
    $path = dijkstra($graph_array, $start, $end);
    $path[1]=[];
    $path[2]=[];
    $path[3]=[];
    foreach ($path[0] as $point) {
        array_push($path[1],$graph_array[$point]["lat"]);
        array_push($path[2],$graph_array[$point]["long"]);
        array_push($path[3],$graph_array[$point]["name"]);
    }
    echo implode(", ", $path[0]);
    echo "{-[][]}-";
    echo implode(", ", $path[1]);
    echo "{-[][]}-";
    echo implode(", ", $path[2]);
    echo "{-[][]}-";
    echo implode(", ", $path[3]);
    // echo "<pre>";
    // _var_dump($path);
    // echo "</pre>";
}else {
function _printOption($graph_array){
    foreach ($graph_array as $key => $value) {
        $value = $value['name'];
        if($value!="路口"){
            echo "<option value='$key'>$value</option>";
        }
    }
}
function _printMap($graph_array){
    foreach ($graph_array as $key => $value) {
        $lat = $value['lat']*1000000-24178100;
        $long = $value['long']*1000000-120646450;
        echo "<circle id='$key' cx='$long' cy='$lat' r='5' fill='black' stroke='black' stroke-width='10' />";
    }
}

    ?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dijkstra</title>
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/tether.min.css">
    <script src="js/jquery-3.1.0.min.js"></script>
    <script src="js/tether.min.js"></script>
    <script src="js/bootstrap.min.js"></script></head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-3 col-lg-3 col-md-2"></div>
            <div class="col-lg-6 col-md-8 col-sm-12 col-xs-12 col-xl-6">
                <form onsubmit="return findPath();">
                    <div class="form-group">
                        <label for="start">起始點</label>
                        <select name="start" class="form-control" id="start" required>
                            <option value=""></option>
                            <option value="0">目前位置</option>
                            <?php _printOption($graph_array);?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lat">LAT</label>
                        <input type="text" class="form-control" name="lat" id="lat" required disabled>
                    </div>
                    <div class="form-group">
                        <label for="long">LONG</label>
                        <input type="text" class="form-control" name="long" id="long" required disabled>
                    </div>
                    <div class="form-group">
                        <label for="end">結束點</label>
                        <select name="end" class="form-control" id="end" required>
                            <option value=""></option>
                            <?php _printOption($graph_array);?>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-primary col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12">尋找</button>
                </form>
                <p class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-xs-12 showPath">asd</p>
            </div>
            <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-xs-12">
                <svg width="100%" height="500" viewBox="-50 -50 3900 3700" style="transform: rotateX(180deg);transition: ">
                    <?php _printMap($graph_array);?>
                </svg>
</div>
        </div>
        <div class="row">
            <div class="col-xl-12">
            </div>
        </div>
    </div>
    <script type="text/javascript">
    function findPath() {
        var data = {}
        if ( $("#start").val()=='0' ) {
            data.lat=$("#lat").val()
            data.long=$("#long").val()
        }else{
            data.start=$("#start").val()
        }
        data.end=$("#end").val()
        $.ajax({    
            method: "GET",            
            cache: false,            
            data: data,            
            success: function(data) {
                data = data.split("{-[][]}-");
                $(".showPath").html(data[3])
                // $(".showPath").append("<hR>")
                // $(".showPath").append(data[1])
                // $(".showPath").append("<hR>")
                // $(".showPath").append(data[2])
                // $(".showPath").append("<hR>")
                // $(".showPath").append(data[3])
            }
        })
        return false;
    }
    $("#start").change(function(event) {
        console.log($("#start").val())
        if($("#start").val()=='0' ){
            $("#lat").prop("disabled", false);
            $("#lat").prop("disabled", false);
            $("#long").prop("disabled", false);
            $("#long").prop("disabled", false);
        }else{
            $("#lat").prop("disabled", true);
            $("#long").prop("disabled", true);
        }
    });
    </script>
</body>
</html>
<?php 
}
?>